---
- name: Configurar Firefox en modo Kiosk en Linux Mint 21.3 (pro)
  hosts: all
  become: true
  gather_facts: true

  vars:
    kiosk_user: kioskuser
    kiosk_url: "https://isard.politecnicllevant.cat/login"
    firefox_path: "/usr/bin/firefox"
    firefox_profile: "/home/{{ kiosk_user }}/.firefox-kiosk"
    kiosk_log: "/home/{{ kiosk_user }}/logs/kiosk.log"

  tasks:

    # -------------------------------
    # Crear usuario kioskuser si no existe
    # -------------------------------
    - name: Crear usuario para Kiosk
      ansible.builtin.user:
        name: "{{ kiosk_user }}"
        state: present
        create_home: yes
        shell: /bin/bash

    # -------------------------------
    # Instalar Firefox
    # -------------------------------
    - name: Instalar Firefox
      ansible.builtin.package:
        name: firefox
        state: present

    # -------------------------------
    # Configurar login automático en LightDM
    # -------------------------------
    - name: Crear directorio de configuración de LightDM
      ansible.builtin.file:
        path: /etc/lightdm/lightdm.conf.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configurar login automático para kioskuser
      ansible.builtin.copy:
        dest: /etc/lightdm/lightdm.conf.d/50-autologin.conf
        content: |
          [Seat:*]
          autologin-user={{ kiosk_user }}
          autologin-user-timeout=0
        owner: root
        group: root
        mode: '0644'

    # -------------------------------
    # Crear perfil dedicado de Firefox
    # -------------------------------
    - name: Crear directorio de perfil Firefox
      ansible.builtin.file:
        path: "{{ firefox_profile }}"
        state: directory
        owner: "{{ kiosk_user }}"
        group: "{{ kiosk_user }}"
        mode: '0700'

    - name: Crear directorio de logs
      ansible.builtin.file:
        path: "/home/{{ kiosk_user }}/logs"
        state: directory
        owner: "{{ kiosk_user }}"
        group: "{{ kiosk_user }}"
        mode: '0755'

    # -------------------------------
    # Crear script de arranque de Firefox Kiosk
    # -------------------------------
    - name: Crear script de arranque de Firefox Kiosk
      ansible.builtin.copy:
        dest: /home/{{ kiosk_user }}/start-firefox-kiosk.sh
        content: |
          #!/bin/bash
          export DISPLAY=:0

          # Esperar a que Xorg esté listo
          while ! xdpyinfo -display :0 >/dev/null 2>&1; do sleep 1; done

          # Ejecutar Firefox en modo kiosk con perfil dedicado y log
          exec {{ firefox_path }} --kiosk -profile {{ firefox_profile }} "{{ kiosk_url }}" >> {{ kiosk_log }} 2>&1
        owner: "{{ kiosk_user }}"
        group: "{{ kiosk_user }}"
        mode: '0755'

    # -------------------------------
    # Crear servicio systemd para Firefox Kiosk
    # -------------------------------
    - name: Crear servicio systemd para Firefox Kiosk
      ansible.builtin.copy:
        dest: /etc/systemd/system/firefox-kiosk.service
        content: |
          [Unit]
          Description=Firefox Kiosk (Linux Mint)
          After=graphical.target
          Requires=graphical.target

          [Service]
          Type=simple
          User={{ kiosk_user }}
          Environment=DISPLAY=:0
          WorkingDirectory=/home/{{ kiosk_user }}
          ExecStart=/home/{{ kiosk_user }}/start-firefox-kiosk.sh
          Restart=always
          TimeoutStartSec=300
          StandardOutput=append:{{ kiosk_log }}
          StandardError=append:{{ kiosk_log }}

          [Install]
          WantedBy=graphical.target
      notify:
        - Recargar systemd

    - name: Habilitar y arrancar el servicio Firefox Kiosk
      ansible.builtin.systemd:
        name: firefox-kiosk.service
        enabled: true
        state: restarted

  handlers:
    - name: Recargar systemd
      ansible.builtin.systemd:
        daemon_reload: yes
